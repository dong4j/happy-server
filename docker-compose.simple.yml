version: '3.8'

services:
    happy-server:
        build:
            context: .
            dockerfile: Dockerfile
        image: happy-server:latest
        container_name: happy-server
        ports:
            - "${HAPPY_SERVER_PORT:-3456}:${PORT:-3005}"
        env_file:
            - .env.dev
        environment:
            - NODE_ENV=${NODE_ENV:-production}
            - PORT=${PORT:-3005}
            - DATABASE_URL=${DATABASE_URL_EXTERNAL:-${DATABASE_URL}}
            - REDIS_URL=${REDIS_URL_EXTERNAL:-${REDIS_URL}}
            - SEED=${SEED:-${HANDY_MASTER_SECRET}}
            - HANDY_MASTER_SECRET=${HANDY_MASTER_SECRET}
            - S3_HOST=${S3_HOST_EXTERNAL:-${S3_HOST}}
            - S3_PORT=${S3_PORT:-9000}
            - S3_USE_SSL=${S3_USE_SSL:-false}
            - S3_ACCESS_KEY=${S3_ACCESS_KEY}
            - S3_SECRET_KEY=${S3_SECRET_KEY}
            - S3_BUCKET=${S3_BUCKET:-happy-files}
            - S3_PUBLIC_URL=${S3_PUBLIC_URL}
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "node", "-e", "require('http').get('http://localhost:${PORT:-3005}/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s
