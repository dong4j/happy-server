version: '3.8'

services:
    postgres:
        image: postgres:15
        container_name: happy-postgres
        environment:
            - POSTGRES_DB=happy-server
            - POSTGRES_USER=postgres
            - POSTGRES_PASSWORD=postgres
        volumes:
            - postgres_data:/var/lib/postgresql/data
        ports:
            - "5432:5432"
        healthcheck:
            test: ["CMD-SHELL", "pg_isready -U postgres"]
            interval: 10s
            timeout: 5s
            retries: 5
        restart: unless-stopped

    redis:
        image: redis:7-alpine
        container_name: happy-redis
        ports:
            - "6379:6379"
        volumes:
            - redis_data:/data
        healthcheck:
            test: ["CMD", "redis-cli", "ping"]
            interval: 10s
            timeout: 5s
            retries: 5
        restart: unless-stopped

    minio:
        image: minio/minio:latest
        container_name: happy-minio
        command: server /data --console-address ":9001"
        environment:
            - MINIO_ROOT_USER=minioadmin
            - MINIO_ROOT_PASSWORD=minioadmin123
        ports:
            - "9000:9000"
            - "9001:9001"
        volumes:
            - minio_data:/data
        healthcheck:
            test: ["CMD", "curl", "-f", "http://localhost:9000/minio/health/live"]
            interval: 30s
            timeout: 20s
            retries: 3
        restart: unless-stopped

    minio-init:
        image: minio/mc:latest
        container_name: happy-minio-init
        depends_on:
            minio:
                condition: service_healthy
        entrypoint: /bin/sh
        command:
            - -c
            - |
                mc alias set local http://minio:9000 minioadmin minioadmin123 &&
                mc mb -p local/happy-files || true &&
                mc anonymous set download local/happy-files
        restart: "no"
        profiles:
            - init

    happy-server:
        build:
            context: .
            dockerfile: Dockerfile
        image: happy-server:latest
        container_name: happy-server
        ports:
            - "3005:3005"
        environment:
            - NODE_ENV=production
            - PORT=3005
            - DATABASE_URL=postgresql://postgres:postgres@postgres:5432/happy-server
            - REDIS_URL=redis://redis:6379
            - S3_HOST=minio
            - S3_PORT=9000
            - S3_USE_SSL=false
            - S3_ACCESS_KEY=minioadmin
            - S3_SECRET_KEY=minioadmin123
            - S3_BUCKET=happy-files
            - S3_PUBLIC_URL=http://localhost:9000/happy-files
            - HANDY_MASTER_SECRET=change-this-to-a-secure-random-string
        depends_on:
            postgres:
                condition: service_healthy
            redis:
                condition: service_healthy
            minio:
                condition: service_healthy
        restart: unless-stopped
        healthcheck:
            test: ["CMD", "node", "-e", "require('http').get('http://localhost:3005/health', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
            interval: 30s
            timeout: 10s
            retries: 3
            start_period: 40s

volumes:
    postgres_data:
    redis_data:
    minio_data:
